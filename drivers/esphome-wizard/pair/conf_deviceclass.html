<!--
    List all virtual devices and allow to change their class
-->
<style>
    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 1200px !important;
    }

    td,
    th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }

    tr:nth-child(even) {
        background-color: #dddddd;
    }
</style>

<script src="logme.js"></script>
<script src="front_utils.js"></script>
<script src="front_configuration.js"></script>
<script type="application/javascript">
    Homey.setTitle(Homey.__('wizard.conf_settings.title'));
    Homey.setNavigationClose();

    Homey.showLoadingOverlay();
</script>
<label class="homey-form-label" data-i18n="wizard.conf_settings.description"></label>

<!--
    physical_device
-->
<br>
<br>
<div class="homey-form-group">
    <!-- Seems useless, it is built from: <ipAddress> + ':' + <port>
    <div class="homey-form-group">
        <label class="homey-form-label" for="physical_device.id" data-i18n="wizard.conf_main.physical_device.id"></label>
        <input class="homey-form-input" id="physical_device.id" type="text" value="" readonly/>
    </div>
    -->
    <div id="deviceList">
    </div>

    <br>
    <button id="apply" class="homey-button-primary-full" data-i18n="wizard.conf_settings.apply"
        onclick="onClickApply(event);"></button>
</div>


<script type="application/javascript">
    /***************
     * HTML Events *
     ***************/

    function onChangeDeviceClass(event, virtualDeviceId) {
        wizardlog('onChangeDeviceClass:', ...arguments);

        let classSelected = document.getElementById("deviceClass" + virtualDeviceId).value;
        document.getElementById("deviceClassDescription" + virtualDeviceId).value = Homey.__("deviceCeviceClass." + document.getElementById("deviceClass" + virtualDeviceId).value + ".description");
    }

    async function onClickApply(event) {
        wizardlog('onClickApply:', ...arguments);

        Homey.showLoadingOverlay();
        try {

            // Don't actually submit the form just yet
            event.preventDefault();

            let data = {
                list: []
            };

            deviceClasses.forEach(deviceClass => {
                let deviceData = {
                    virtualDeviceId: deviceClass.virtualDeviceId,
                    'deviceClass': document.getElementById("deviceClass" + deviceClass.virtualDeviceId).value
                };
                data.list.push(deviceData);
            });

            wizardlog('Send event set-device-classes with data:', data);
            Homey.emit('set-device-classes', data)
                .catch(e => { wizarderror(e); });
            Homey.done();
        } catch (e) {
            wizarderror(e);
        } finally {
            Homey.hideLoadingOverlay();
        }
    }

    async function _init() {
        let physicalDeviceId = await Homey.getViewStoreValue('store', 'physical_device_id')
            .catch(e => { wizarderror(e); });

        deviceClasses = await Homey.emit('get-device-classes', {})
            .catch(e => { wizarderror(e); });

        wizardlog('Initial deviceClasses:', deviceClasses);

        let deviceListElement = document.getElementById("deviceList");
        let innerHTML = '';

        deviceClasses.forEach(deviceClass => {
            innerHTML += '<label class="homey-form-label" for="deviceName" data-i18n="wizard.conf_deviceclass.deviceName"></label>';
            innerHTML += '<input class="homey-form-input" id="deviceName" type="text" readonly value=' + '"' + deviceClass.virtualDeviceName + '"' + '/>';
            innerHTML += '<label class="homey-form-label" for="deviceClass" data-i18n="wizard.conf_deviceclass.deviceClass"></label>';
            innerHTML += '<select class="homey-form-select" id="deviceClass' + deviceClass.virtualDeviceId + '" onchange="onChangeDeviceClass(event, ' + "'" + deviceClass.virtualDeviceId + "'" + ');">';
            CLASS_CONFIGURATION.forEach(classType => {
                if (deviceClass.deviceClass === classType) {
                    innerHTML += '<option value="' + classType + '" selected>' + Homey.__("deviceClass." + classType + ".label") + '</option>';
                } else {
                    innerHTML += '<option value="' + classType + '">' + Homey.__("deviceClass." + classType + ".label") + '</option>';
                }
            });
            innerHTML += '</select>';
            innerHTML += '<label class="homey-form-label" for="deviceClassDescription"';
            innerHTML += 'data-i18n="wizard.conf_deviceclass.deviceClassDescription"></label>';
            innerHTML += '<label class="homey-form-label" id="deviceClassDescription' + deviceClass.virtualDeviceId + '""></label>';
        });

        deviceListElement.innerHTML = innerHTML;
        
        Homey.hideLoadingOverlay();
    }

    /*************
     * MAIN CODE *
     *************/

    deviceClasses = null;

    // Disable connect button by default
    //disableButton(document.getElementById('apply'));

    _init();
</script>