<!--
    Allows to connect to a new physical device
-->

<script src="front_utils.js"></script>
<script type="application/javascript">
    Homey.setTitle(Homey.__('wizard.new_device.title'));
    Homey.setNavigationClose();
</script>
<header class="homey-header" data-i18n="wizard.new_device.description"></header>
<label class="homey-form-label" for="ipAddress" data-i18n="wizard.new_device.ipAddress"></label>
<input class="homey-form-input" id="ipAddress" type="text" maxlength="15" oninput="onInputCheckConnectButton(event);" />
<label class="homey-form-label" for="port" data-i18n="wizard.new_device.port"></label>
<input class="homey-form-input" id="port" type="text" maxlength="5" placeholder="6053"
    oninput="onInputCheckConnectButton(event);" />
<label class="homey-form-label" for="password" data-i18n="wizard.new_device.password"></label>
<input class="homey-form-input" id="password" type="text" maxlength="20" />

<br>
<button id="connect" class="homey-button-primary-full" data-i18n="wizard.new_device.connect"
    onclick="onClickConnect(event);"></button>
<script type="application/javascript">
    /***************
     * HTML Events *
     ***************/

    function onInputCheckConnectButton(event) {
        console.log('onInputCheckConnectButton:', ...arguments);

        let ipAddress = document.getElementById("ipAddress").value;
        let port = getPortOrDefault(document.getElementById("port").value);

        // check ipAddress is not empty
        if (!ipAddress || !checkIfValidIpAddress(ipAddress) || !checkIfValidPort(port))
            disableButton(document.getElementById('connect'));
        else
            enableButton(document.getElementById('connect'));
    }

    function onClickConnect(event) {
        console.log('onClickConnect:', ...arguments);

        Homey.showLoadingOverlay();

        // Don't actually submit the form just yet
        event.preventDefault();

        let data = {
            'ipAddress': document.getElementById("ipAddress").value,
            'port': getPortOrDefault(document.getElementById("port").value),
            'password': document.getElementById("password").value
        };

        console.log('Send event connect-new-device with data:', data);
        Homey.emit('connect-new-device', data);
    }


    /*************
     * MAIN CODE *
     *************/

    // Disable connect button by default
    disableButton(document.getElementById('connect'));

    Homey.on('new-device-connected', function () {
        console.log('Event new-device-connected received');

        Homey.setViewStoreValue('store', 'physical_device_id', document.getElementById("ipAddress").value + ':' + getPortOrDefault(document.getElementById("port").value)).then(() => {
            // Let's wait a few seconds to make sure the driver finished collecting data about the device
            setTimeout(() => {
                Homey.hideLoadingOverlay();
                Homey.showView('conf_main');
            }, 5000);
        });
    });

    Homey.on('new-device-failed', function (message) {
        console.log('Event new-device-failedreceived:', message);

        Homey.hideLoadingOverlay();
        Homey.alert(message, 'error');
    });
</script>