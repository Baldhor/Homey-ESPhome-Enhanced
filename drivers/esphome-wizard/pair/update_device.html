<script type="application/javascript">
    Homey.setTitle(Homey.__('wizard.new_device.title'));
    Homey.setNavigationClose();
</script>
<header class="homey-header" data-i18n="wizard.update_device.description"></header>
<form class="homey-form">
    <table id="existing_devices">
        <tr>
            <th></th>
            <th>
                <legend class="homey-form-legend" data-i18n="wizard.update_device.id"></legend>
            </th>
            <th>
                <legend class="homey-form-legend" data-i18n="wizard.update_device.ipAddress"></legend>
            </th>
            <th>
                <legend class="homey-form-legend" data-i18n="wizard.update_device.port"></legend>
            </th>
            <th>
                <legend class="homey-form-legend" data-i18n="wizard.update_device.bound"></legend>
            </th>
        </tr>
    </table>
    </div>

    <button id="select" class="homey-button-primary-full" data-i18n="wizard.update_device.select"></button>
</form>
<script type="application/javascript">
    // We need to init the view
    Homey.showLoadingOverlay();

    const selectElement = document.getElementById('select');
    const listElement = document.getElementById('existing_devices');

    // Get existing device from homey
    var existingDevices = null;
    Homey.emit("get-existing-device").then(function (result) {
        console.log('Existing devices:', result); // result is: Hello!
        existingDevices = result;
    });

    function enableSelectButton() {
        if (selectElement.classList.contains("is-disabled"))
            selectElement.classList.remove("is-disabled");
        selectElement.disabled = false;
    }

    function disableSelectButton() {
        if (!selectElement.classList.contains("is-disabled"))
            selectElement.classList.add("is-disabled");
        selectElement.disabled = true;
    }

    // Loop on each device and add them to the list with a radio button
    // Using physical device id to identify the radio button
    existingDevices.forEach(element => {
        var row = listElement.insertRow(-1);
        var cellSelect = row.insertCell(0);
        var cellId = row.insertCell(1);
        var cellIpAddress = row.insertCell(2);
        var cellPort = row.insertCell(3);
        var cellBound = row.insertCell(4);

        cellSelect.innerHTML = '<input class="homey-form-radio-input" type="radio" name="radio-buttons" id="' + element.id + '"/>';
        cellId.innerHTML = '<label class="homey-form-label">' + element.id + '</label>';
        cellIpAddress.innerHTML = '<label class="homey-form-label">' + element.ipAddress + '</label>';
        cellPort.innerHTML = '<label class="homey-form-label">' + element.port + '</label>';
        cellBound.innerHTML = '<label class="homey-form-label">' + element.bound + '</label>';

        // Add a listener to update the select button
        document.getElementById('element.id').on('change', () => enableSelectButton());;
    });

    // Make sure the select button is disabled by default: need to select one device in the list!
    disableSelectButton();

    // Finished init of the view
    Homey.hideLoadingOverlay();
</script>