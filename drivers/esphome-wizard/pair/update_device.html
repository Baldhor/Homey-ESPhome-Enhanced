<!--
    Allows to choose an existing physical device to modify
-->

<script type="application/javascript">
    Homey.setTitle(Homey.__('wizard.update_device.title'));
    Homey.setNavigationClose();

    Homey.showLoadingOverlay();
</script>
<header class="homey-header" data-i18n="wizard.update_device.description"></header>
<label class="homey-form-label" data-i18n="wizard.update_device.info"></label>

<label id="none" class="homey-form-label" data-i18n="wizard.update_device.none" style="color:red;"></label>

<table id="existing_devices">
    <tr>
        <th></th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.id"></legend>
        </th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.ipAddress"></legend>
        </th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.port"></legend>
        </th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.bound"></legend>
        </th>
    </tr>
</table>

<button id="select" class="homey-button-primary-full" data-i18n="wizard.update_device.select"></button>
<script type="application/javascript">
    const noneElement = document.getElementById('none');
    const listElement = document.getElementById('existing_devices');
    const selectElement = document.getElementById('select');

    function enableSelectButton() {
        if (selectElement.classList.contains("is-disabled"))
            selectElement.classList.remove("is-disabled");
        selectElement.disabled = false;
    }

    function disableSelectButton() {
        if (!selectElement.classList.contains("is-disabled"))
            selectElement.classList.add("is-disabled");
        selectElement.disabled = true;
    }

    function hideAll(element) {
        element.hidden = true;
        Array.from(element.children).forEach(function(subElement){
            subElement.hidden = true;
        });
    }

    // Make sure the select button is disabled by default: need to select one device in the list!
    disableSelectButton();

    // Get existing device from homey
    var existingDevices = null;
    Homey.emit("get-existing-device").then(function (result) {
        console.log('Existing devices:', result); // result is: Hello!
        existingDevices = result;

        if (existingDevices.length === 0) {
            // Hide list and select button
            hideAll(listElement);
            hideAll(selectElement);
        } else {
            // Hide none
            hideAll(noneElement);

            // Loop on each device and add them to the list with a radio button
            // Using physical device id to identify the radio button
            existingDevices.forEach(element => {
                var row = listElement.insertRow(-1);
                var cellSelect = row.insertCell(0);
                var cellId = row.insertCell(1);
                var cellIpAddress = row.insertCell(2);
                var cellPort = row.insertCell(3);
                var cellBound = row.insertCell(4);

                cellSelect.innerHTML = '<input class="homey-form-radio-input" type="radio" name="radio-buttons" id="' + element.id + '"/>';
                cellId.innerHTML = '<label class="homey-form-label">' + element.id + '</label>';
                cellIpAddress.innerHTML = '<label class="homey-form-label">' + element.ipAddress + '</label>';
                cellPort.innerHTML = '<label class="homey-form-label">' + element.port + '</label>';
                cellBound.innerHTML = '<label class="homey-form-label">' + element.bound + '</label>';

                // Add a listener to update the select button
                document.getElementById(element.id).onchange = enableSelectButton;
            });
        }

        // Finished init of the view
        Homey.hideLoadingOverlay();
    });

    // Add submit function
    function select(event) {
        Homey.showLoadingOverlay();

        // Don't actually submit the form just yet
        event.preventDefault();

        Homey.setViewStoreValue('store', 'physical_device_id', document.querySelector('input[name="radio-buttons"]:checked').value).then(() => {
            Homey.hideLoadingOverlay();
            Homey.showView('conf_main');
        });
    }
    
    selectElement.onclick = select;
</script>
