<!--
    Allows to choose an existing physical device to modify
-->
<script src="front_utils.js"></script>
<script type="application/javascript">
    Homey.setTitle(Homey.__('wizard.update_device.title'));
    Homey.setNavigationClose();

    Homey.showLoadingOverlay();
</script>
<header class="homey-header" data-i18n="wizard.update_device.description"></header>
<label class="homey-form-label" data-i18n="wizard.update_device.info"></label>

<label id="none" class="homey-form-label" data-i18n="wizard.update_device.none" style="color:red;"></label>

<table id="existing_devices">
    <tr>
        <th></th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.id"></legend>
        </th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.ipAddress"></legend>
        </th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.port"></legend>
        </th>
        <th>
            <legend class="homey-form-legend" data-i18n="wizard.update_device.bound"></legend>
        </th>
    </tr>
</table>

<button id="select" class="homey-button-primary-full" data-i18n="wizard.update_device.select"
    onclick="onClickSelect(event);"></button>
<script type="application/javascript">
    /***************
     * HTML Events *
     ***************/

    function onChangeRadio(event) {
        console.log('onChangeRadio:', ...arguments);

        enableButton(document.getElementById('select'));
    }

    function onClickSelect(event) {
        console.log('onChangeSelect:', ...arguments);

        Homey.showLoadingOverlay();

        // Don't actually submit the form just yet
        event.preventDefault();

        Homey.setViewStoreValue('store', 'physical_device_id', document.querySelector('input[name="radio-buttons"]:checked').value).then(() => {
            Homey.hideLoadingOverlay();
            Homey.showView('conf_main');
        });
    }


    /*************
     * MAIN CODE *
     *************/

    // Make sure the select button is disabled by default: need to select one device in the list!
    disableButton(document.getElementById('select'));

    // Get existing device from homey
    var existingDevices = null;
    Homey.emit("get-existing-devices").then(result => {
        console.log('Existing devices:', result);
        existingDevices = result;

        if (existingDevices.length === 0) {
            // Hide list and select button
            hideAll(document.getElementById('existing_devices'));
            hideAll(document.getElementById('select'));
        } else {
            // Hide none
            hideAll(document.getElementById('none'));

            // Loop on each device and add them to the list with a radio button
            // Using physical device id to identify the radio button
            existingDevices.forEach(element => {
                var row = listElement.insertRow(-1);
                var cellSelect = row.insertCell(0);
                var cellId = row.insertCell(1);
                var cellIpAddress = row.insertCell(2);
                var cellPort = row.insertCell(3);
                var cellBound = row.insertCell(4);

                cellSelect.innerHTML = '<input class="homey-form-radio-input" type="radio" name="radio-buttons" id="' + element.id + '" onchange="onChangeRadio(event);"/>';
                cellId.innerHTML = '<label class="homey-form-label">' + element.id + '</label>';
                cellIpAddress.innerHTML = '<label class="homey-form-label">' + element.ipAddress + '</label>';
                cellPort.innerHTML = '<label class="homey-form-label">' + element.port + '</label>';
                cellBound.innerHTML = '<label class="homey-form-label">' + element.bound + '</label>';
            });
        }

        // Finished init of the view
        Homey.hideLoadingOverlay();
    });
</script>